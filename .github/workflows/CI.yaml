name: Run Tests

on:
  pull_request:
  push:
    branches:
      - "main"
      - "breaking"
  workflow_dispatch:

jobs:
  run-tests-modern-python:
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14.0-rc.3"]
        runs-on: ["ubuntu-24.04"]
        include:
          - runs-on: "macos-15"
            python-version: "3.13"
          - runs-on: "macos-15"
            python-version: "3.9"
    # Pull in the test script from run_tests and distribute python from matrix versions
    uses: ./.github/workflows/run_tests.yaml
    with:
      python-version: ${{ matrix.python-version }}
      runs-on: ${{ matrix.runs-on }}
      requirements-file: ".github/requirements-${{ matrix.python-version }}.txt"

  # run-tests-legacy-python:
  #   needs: run-tests-modern-python # Wait until tests pass on python 3.9+
  #   strategy:
  #     fail-fast: false # Legacy versions are much less stable - run tests independently
  #     matrix: # Code works on py3.6, but type annotations are broken
  #       python-version: ["3.8"]
  #       runs-on: ["ubuntu-22.04", "macos-14"]
  #   uses: ./.github/workflows/run_tests.yaml
  #   with:
  #     python-version: ${{ matrix.python-version }}
  #     runs-on: ${{ matrix.runs-on }}
  #     requirements-file: ".github/requirements-${{ matrix.python-version }}.txt"

  run-tests-windows:
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.13", "3.14"]
        runs-on: ["windows-2025"]
    uses: ./.github/workflows/run_tests.yaml
    with:
      python-version: ${{ matrix.python-version }}
      runs-on: ${{ matrix.runs-on }}
      requirements-file: ".github/requirements-${{ matrix.python-version }}.txt"

  # This job is used to provide a single requirement for branch merge conditions.
  tests_complete:
    name: Unit test
    if: always()
    needs: [run-tests-modern-python, run-tests-windows]
    runs-on: ubuntu-24.04

    steps:
    - run: jq --exit-status 'all(.result == "success")' <<< '${{ toJson(needs) }}'
    - name: Done
      run: exit 0
